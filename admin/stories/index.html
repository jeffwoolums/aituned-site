<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stories Admin ‚Äî LessonCraft</title>
<style>
  :root {
    --navy: #1A1A2E;
    --gold: #C9A84C;
    --cream: #F5F0E8;
    --green: #2d6a4f;
    --red: #c0392b;
    --orange: #e67e22;
    --gray: #6c757d;
    --light: #f8f9fa;
    --border: #dee2e6;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--light);
    color: var(--navy);
    line-height: 1.5;
  }

  /* Auth overlay */
  #auth-overlay {
    position: fixed; inset: 0;
    background: var(--navy);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
  }
  #auth-overlay.hidden { display: none; }
  .auth-card {
    background: white;
    border-radius: 16px;
    padding: 40px;
    width: 380px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .auth-card h1 {
    font-size: 24px;
    margin-bottom: 8px;
    color: var(--navy);
  }
  .auth-card p {
    font-size: 14px;
    color: var(--gray);
    margin-bottom: 24px;
  }
  .auth-card input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 10px;
    font-size: 15px;
    outline: none;
    transition: border-color 0.2s;
  }
  .auth-card input:focus { border-color: var(--gold); }
  .auth-card .auth-error {
    color: var(--red);
    font-size: 13px;
    margin-top: 8px;
    min-height: 20px;
  }
  .auth-card button {
    margin-top: 16px;
    width: 100%;
    padding: 12px;
    background: var(--gold);
    color: var(--navy);
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .auth-card button:hover { opacity: 0.9; }

  /* Header */
  header {
    background: var(--navy);
    color: white;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  header h1 {
    font-size: 20px;
    font-weight: 700;
  }
  header h1 span { color: var(--gold); }
  .header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .header-actions button {
    background: rgba(255,255,255,0.15);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .header-actions button:hover { background: rgba(255,255,255,0.25); }

  /* Stats bar */
  .stats-bar {
    display: flex;
    gap: 16px;
    padding: 16px 24px;
    background: white;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .stat-card {
    padding: 12px 20px;
    border-radius: 10px;
    background: var(--light);
    min-width: 120px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
  }
  .stat-card:hover { border-color: var(--gold); }
  .stat-card.active { border-color: var(--gold); background: #faf6eb; }
  .stat-card .stat-num {
    font-size: 28px;
    font-weight: 700;
    color: var(--navy);
  }
  .stat-card .stat-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--gray);
    font-weight: 600;
  }
  .stat-card.pending .stat-num { color: var(--orange); }
  .stat-card.approved .stat-num { color: var(--green); }
  .stat-card.rejected .stat-num { color: var(--red); }

  /* Controls */
  .controls {
    padding: 16px 24px;
    background: white;
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
  }
  
  .search-box {
    flex: 1;
    min-width: 200px;
    position: relative;
  }
  .search-box input {
    width: 100%;
    padding: 10px 16px 10px 40px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    background: white;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-box input:focus { border-color: var(--gold); }
  .search-box::before {
    content: 'üîç';
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
  }

  .filters {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  .filters select {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    background: white;
    cursor: pointer;
    outline: none;
  }
  .filters select:focus { border-color: var(--gold); }
  .filters label {
    font-size: 13px;
    color: var(--gray);
    font-weight: 600;
  }

  .bulk-actions {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    padding: 8px 16px;
    background: rgba(201, 168, 76, 0.1);
    border-radius: 8px;
    border: 1px solid var(--gold);
  }
  .btn-bulk {
    background: var(--gray);
    color: white;
    padding: 6px 12px;
    font-size: 12px;
  }
  #selected-count {
    font-size: 12px;
    color: var(--gray);
    font-weight: 600;
  }

  /* Story list */
  .story-list {
    padding: 0 24px 24px;
  }
  .story-card {
    background: white;
    border-radius: 12px;
    border: 1px solid var(--border);
    margin-bottom: 12px;
    overflow: hidden;
    transition: box-shadow 0.2s;
  }
  .story-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
  .story-header {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    cursor: pointer;
  }
  .story-checkbox {
    margin: 0;
    cursor: pointer;
  }
  .story-checkbox input {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }
  .story-status {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }
  .story-status.pending { background: #fff3cd; color: #856404; }
  .story-status.approved { background: #d4edda; color: #155724; }
  .story-status.rejected { background: #f8d7da; color: #721c24; }

  .story-meta {
    flex: 1;
    min-width: 0;
  }
  .story-meta .story-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--navy);
    margin-bottom: 4px;
  }
  .story-meta .story-preview {
    font-size: 14px;
    color: #444;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .story-meta .story-info {
    font-size: 12px;
    color: var(--gray);
    margin-top: 4px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .story-meta .story-info span { white-space: nowrap; }
  .story-category {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    background: #e8e3f3;
    color: #5a3d8a;
    white-space: nowrap;
  }
  .story-toggle {
    color: var(--gray);
    font-size: 18px;
    transition: transform 0.2s;
  }
  .story-card.expanded .story-toggle { transform: rotate(180deg); }

  /* Story detail (expanded) */
  .story-detail {
    display: none;
    padding: 0 20px 20px;
    border-top: 1px solid var(--border);
  }
  .story-card.expanded .story-detail { display: block; }

  .story-full-text {
    background: var(--cream);
    border-radius: 10px;
    padding: 20px;
    margin: 16px 0;
    font-size: 15px;
    line-height: 1.7;
    white-space: pre-wrap;
    max-height: 400px;
    overflow-y: auto;
  }

  .detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    margin: 16px 0;
  }
  .detail-item {
    font-size: 13px;
  }
  .detail-item .label {
    font-weight: 600;
    color: var(--gray);
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.5px;
  }
  .detail-item .value {
    color: var(--navy);
    margin-top: 2px;
  }

  .mod-actions {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }
  .btn {
    padding: 8px 20px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
    white-space: nowrap;
  }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-approve { background: var(--green); color: white; }
  .btn-reject { background: var(--red); color: white; }

  /* Loading / empty */
  .loading, .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--gray);
  }
  .loading::after {
    content: '';
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 3px solid var(--border);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-left: 12px;
    vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    color: white;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s;
    z-index: 200;
    max-width: 400px;
  }
  .toast.show { opacity: 1; transform: translateY(0); }
  .toast.success { background: var(--green); }
  .toast.error { background: var(--red); }

  /* Responsive */
  @media (max-width: 768px) {
    header h1 { font-size: 16px; }
    .stats-bar { gap: 8px; padding: 12px 16px; }
    .stat-card { padding: 8px 14px; min-width: 80px; }
    .stat-card .stat-num { font-size: 22px; }
    .story-list { padding: 0 12px 12px; }
    .story-header { padding: 12px 14px; gap: 10px; }
    .controls { padding: 10px 12px; }
    .search-box { min-width: 150px; }
    .detail-grid { grid-template-columns: 1fr; }
    .mod-actions { flex-wrap: wrap; }
  }

  @media (max-width: 480px) {
    .controls { flex-direction: column; align-items: stretch; }
    .search-box { min-width: 100%; }
    .filters { justify-content: space-between; }
  }
</style>
</head>
<body>

<!-- Auth overlay -->
<div id="auth-overlay">
  <div class="auth-card">
    <h1>üîê Stories Admin</h1>
    <p>Enter admin password to access the moderation dashboard</p>
    <input type="password" id="auth-password" placeholder="Admin Password" autocomplete="off">
    <div class="auth-error" id="auth-error"></div>
    <button onclick="authenticate()">Sign In</button>
  </div>
</div>

<!-- Main app -->
<header>
  <h1><span>LessonCraft</span> Stories Admin</h1>
  <div class="header-actions">
    <button onclick="loadStories()" title="Refresh">‚Üª Refresh</button>
    <button onclick="logout()">Sign Out</button>
  </div>
</header>

<div class="stats-bar" id="stats-bar">
  <div class="stat-card active" data-filter="all" onclick="filterByStatus('all', this)">
    <div class="stat-num" id="stat-total">‚Äî</div>
    <div class="stat-label">Total</div>
  </div>
  <div class="stat-card pending" data-filter="pending" onclick="filterByStatus('pending', this)">
    <div class="stat-num" id="stat-pending">‚Äî</div>
    <div class="stat-label">Pending</div>
  </div>
  <div class="stat-card approved" data-filter="approved" onclick="filterByStatus('approved', this)">
    <div class="stat-num" id="stat-approved">‚Äî</div>
    <div class="stat-label">Approved</div>
  </div>
  <div class="stat-card rejected" data-filter="rejected" onclick="filterByStatus('rejected', this)">
    <div class="stat-num" id="stat-rejected">‚Äî</div>
    <div class="stat-label">Rejected</div>
  </div>
</div>

<div class="controls">
  <div class="search-box">
    <input type="text" id="search-input" placeholder="Search by author name or content..." oninput="handleSearch()">
  </div>
  <div class="filters">
    <label for="filter-category">Category:</label>
    <select id="filter-category" onchange="applyFilters()">
      <option value="">All Categories</option>
    </select>
    
    <label for="sort-order">Sort:</label>
    <select id="sort-order" onchange="applySorting()">
      <option value="newest">Newest First</option>
      <option value="oldest">Oldest First</option>
    </select>
  </div>
  
  <div class="bulk-actions" id="bulk-actions" style="display: none;">
    <button class="btn btn-bulk" onclick="selectAll()">Select All</button>
    <button class="btn btn-bulk" onclick="selectNone()">Select None</button>
    <button class="btn btn-approve" onclick="bulkModerate('approve')">Bulk Approve</button>
    <button class="btn btn-reject" onclick="bulkModerate('reject')">Bulk Reject</button>
    <span id="selected-count">0 selected</span>
  </div>
</div>

<div class="story-list" id="story-list">
  <div class="loading" id="loading">Loading stories</div>
</div>

<div class="toast" id="toast"></div>

<script>
const API_BASE = 'https://api.aituned.io/api';
const ADMIN_PASSWORD = 'tred2026';
let isAuthenticated = false;
let currentStatusFilter = 'all';
let allStories = [];
let filteredStories = [];
let selectedStories = new Set();
let searchTimeout = null;
let categories = new Set();

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
function authenticate() {
  const password = document.getElementById('auth-password').value.trim();
  const errorEl = document.getElementById('auth-error');
  
  if (!password) {
    errorEl.textContent = 'Please enter the admin password';
    return;
  }
  
  if (password !== ADMIN_PASSWORD) {
    errorEl.textContent = 'Invalid password';
    return;
  }
  
  isAuthenticated = true;
  sessionStorage.setItem('stories-admin-auth', 'true');
  document.getElementById('auth-overlay').classList.add('hidden');
  loadStories();
}

function logout() {
  isAuthenticated = false;
  sessionStorage.removeItem('stories-admin-auth');
  document.getElementById('auth-overlay').classList.remove('hidden');
  document.getElementById('auth-password').value = '';
  document.getElementById('auth-error').textContent = '';
}

// Auto-login from session
(function() {
  if (sessionStorage.getItem('stories-admin-auth') === 'true') {
    isAuthenticated = true;
    document.getElementById('auth-overlay').classList.add('hidden');
    loadStories();
  }
  
  // Enter key on auth input
  document.getElementById('auth-password').addEventListener('keydown', e => {
    if (e.key === 'Enter') authenticate();
  });
})();

// ‚îÄ‚îÄ Load stories ‚îÄ‚îÄ
async function loadStories() {
  if (!isAuthenticated) return;
  
  const listEl = document.getElementById('story-list');
  listEl.innerHTML = '<div class="loading">Loading stories</div>';

  try {
    const res = await fetch(`${API_BASE}/stories?limit=1000`);
    if (!res.ok) throw new Error(`API error: ${res.status}`);
    
    const data = await res.json();
    allStories = data.stories || [];
    
    // Extract categories for filter
    categories.clear();
    allStories.forEach(story => {
      if (story.category) categories.add(story.category);
    });
    populateCategoryFilter();
    
    updateStats();
    applyFilters();
    
  } catch (err) {
    console.error('Load stories error:', err);
    listEl.innerHTML = `<div class="empty-state">Error loading stories: ${err.message}</div>`;
  }
}

function populateCategoryFilter() {
  const select = document.getElementById('filter-category');
  const currentValue = select.value;
  
  // Keep "All Categories" and add found categories
  select.innerHTML = '<option value="">All Categories</option>';
  
  Array.from(categories).sort().forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = formatCategory(cat);
    select.appendChild(option);
  });
  
  // Restore selection
  if (currentValue && categories.has(currentValue)) {
    select.value = currentValue;
  }
}

function updateStats() {
  const stats = allStories.reduce((acc, story) => {
    acc.total++;
    acc[story.status] = (acc[story.status] || 0) + 1;
    return acc;
  }, { total: 0, pending: 0, approved: 0, rejected: 0 });

  document.getElementById('stat-total').textContent = stats.total;
  document.getElementById('stat-pending').textContent = stats.pending;
  document.getElementById('stat-approved').textContent = stats.approved;
  document.getElementById('stat-rejected').textContent = stats.rejected;
}

function applyFilters() {
  const categoryFilter = document.getElementById('filter-category').value;
  const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
  
  filteredStories = allStories.filter(story => {
    // Status filter
    if (currentStatusFilter !== 'all' && story.status !== currentStatusFilter) {
      return false;
    }
    
    // Category filter
    if (categoryFilter && story.category !== categoryFilter) {
      return false;
    }
    
    // Search filter
    if (searchTerm) {
      const searchableText = [
        story.displayName || '',
        story.initials || '', 
        story.title || '',
        story.preview || '',
        story.fullText || story.story || '',
        story.faithTradition || '',
        story.location || ''
      ].join(' ').toLowerCase();
      
      if (!searchableText.includes(searchTerm)) {
        return false;
      }
    }
    
    return true;
  });
  
  applySorting();
}

function applySorting() {
  const sortOrder = document.getElementById('sort-order').value;
  
  filteredStories.sort((a, b) => {
    const dateA = new Date(a.createdAt || 0);
    const dateB = new Date(b.createdAt || 0);
    
    return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
  });
  
  renderStories();
}

function renderStories() {
  const listEl = document.getElementById('story-list');
  
  if (filteredStories.length === 0) {
    listEl.innerHTML = '<div class="empty-state">No stories match the current filters</div>';
    selectedStories.clear();
    updateSelectionUI();
    return;
  }
  
  listEl.innerHTML = filteredStories.map(story => renderStoryCard(story)).join('');
  
  // Restore checkbox states
  selectedStories.forEach(storyId => {
    const checkbox = document.getElementById(`check-${storyId}`);
    if (checkbox) checkbox.checked = true;
  });
  updateSelectionUI();
}

function renderStoryCard(story) {
  const date = story.createdAt ? new Date(story.createdAt).toLocaleDateString('en-US', {
    month: 'short', day: 'numeric', year: 'numeric'
  }) : '‚Äî';
  
  const initials = story.initials || story.displayName || '‚Äî';
  const title = story.title || '';
  const preview = story.preview || (story.fullText || story.story || '').substring(0, 100);
  const faith = story.faithTradition || '';
  const location = story.location || '';
  const category = formatCategory(story.category);

  return `
    <div class="story-card" id="card-${story.id || story.storyId}">
      <div class="story-header">
        <div class="story-checkbox" onclick="event.stopPropagation()">
          <input type="checkbox" id="check-${story.id || story.storyId}" onchange="toggleSelection('${story.id || story.storyId}')">
        </div>
        <span class="story-status ${story.status}">${story.status}</span>
        <div class="story-meta" onclick="toggleCard('${story.id || story.storyId}')">
          ${title ? `<div class="story-title">${escapeHtml(title)}</div>` : ''}
          <div class="story-preview">${escapeHtml(preview)}${preview.length >= 100 ? '...' : ''}</div>
          <div class="story-info">
            <span>üìÖ ${date}</span>
            <span>üë§ ${escapeHtml(initials)}</span>
            ${faith ? `<span>‚õ™ ${escapeHtml(faith)}</span>` : ''}
            ${location ? `<span>üìç ${escapeHtml(location)}</span>` : ''}
            ${story.hasAudio ? '<span>üéôÔ∏è Audio</span>' : ''}
          </div>
        </div>
        <span class="story-category">${category}</span>
        <span class="story-toggle" onclick="toggleCard('${story.id || story.storyId}')">‚ñæ</span>
      </div>
      <div class="story-detail" id="detail-${story.id || story.storyId}">
        ${renderStoryDetail(story)}
      </div>
    </div>`;
}

function renderStoryDetail(story) {
  const created = story.createdAt ? new Date(story.createdAt).toLocaleString() : '‚Äî';
  const fullText = story.fullText || story.story || '';

  return `
    <div class="detail-grid">
      <div class="detail-item">
        <div class="label">Author</div>
        <div class="value">${escapeHtml(story.displayName || '‚Äî')}</div>
      </div>
      <div class="detail-item">
        <div class="label">Title</div>
        <div class="value">${escapeHtml(story.title || '‚Äî')}</div>
      </div>
      <div class="detail-item">
        <div class="label">Location</div>
        <div class="value">${escapeHtml(story.location || '‚Äî')}</div>
      </div>
      <div class="detail-item">
        <div class="label">Category</div>
        <div class="value">${formatCategory(story.category)}</div>
      </div>
      <div class="detail-item">
        <div class="label">Faith Tradition</div>
        <div class="value">${escapeHtml(story.faithTradition || '‚Äî')}</div>
      </div>
      <div class="detail-item">
        <div class="label">Submitted</div>
        <div class="value">${created}</div>
      </div>
    </div>

    <div class="story-full-text">${escapeHtml(fullText)}</div>

    ${story.audioUrl ? `<div style="margin: 12px 0;"><audio controls src="${story.audioUrl}" style="width:100%;max-width:400px;"></audio></div>` : ''}

    <div class="mod-actions">
      <button class="btn btn-approve" onclick="moderate('${story.id || story.storyId}', 'approve')" ${story.status === 'approved' ? 'disabled' : ''}>
        ‚úì Approve
      </button>
      <button class="btn btn-reject" onclick="moderate('${story.id || story.storyId}', 'reject')" ${story.status === 'rejected' ? 'disabled' : ''}>
        ‚úó Reject
      </button>
    </div>`;
}

// ‚îÄ‚îÄ Toggle card ‚îÄ‚îÄ
function toggleCard(storyId) {
  const card = document.getElementById(`card-${storyId}`);
  card.classList.toggle('expanded');
}

// ‚îÄ‚îÄ Search ‚îÄ‚îÄ
function handleSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    applyFilters();
  }, 300); // Debounce search
}

// ‚îÄ‚îÄ Moderate ‚îÄ‚îÄ
async function moderate(storyId, action, silent = false) {
  if (!isAuthenticated) return;
  
  const card = document.getElementById(`card-${storyId}`);
  const buttons = card ? card.querySelectorAll('.btn') : [];
  
  // Disable buttons during request
  buttons.forEach(btn => btn.disabled = true);

  try {
    const res = await fetch(`${API_BASE}/stories/${storyId}/moderate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action }),
    });

    if (!res.ok) throw new Error(`API error: ${res.status}`);
    const data = await res.json();

    if (data.success || res.ok) {
      const newStatus = action === 'approve' ? 'approved' : 'rejected';
      if (!silent) showToast(`Story ${newStatus}!`, 'success');
      
      // Update story in cache
      const storyIndex = allStories.findIndex(s => (s.id || s.storyId) == storyId);
      if (storyIndex >= 0) {
        allStories[storyIndex].status = newStatus;
      }
      
      // Update UI only if card exists (not in bulk mode)
      if (card) {
        const badge = card.querySelector('.story-status');
        if (badge) {
          badge.className = `story-status ${newStatus}`;
          badge.textContent = newStatus;
        }
        
        // Update button states
        const approveBtn = card.querySelector('.btn-approve');
        const rejectBtn = card.querySelector('.btn-reject');
        if (approveBtn) approveBtn.disabled = newStatus === 'approved';
        if (rejectBtn) rejectBtn.disabled = newStatus === 'rejected';
      }
      
      // Refresh stats
      updateStats();
    } else {
      throw new Error(data.error || 'Moderation failed');
    }
  } catch (err) {
    console.error('Moderation error:', err);
    if (!silent) showToast('Error: ' + err.message, 'error');
    buttons.forEach(btn => btn.disabled = false);
    throw err; // Re-throw for bulk operation handling
  }
}

// ‚îÄ‚îÄ Filters ‚îÄ‚îÄ
function filterByStatus(status, el) {
  currentStatusFilter = status;
  document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
  if (el) el.classList.add('active');
  applyFilters();
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function formatCategory(cat) {
  if (!cat) return '‚Äî';
  return cat.split('_').map(word => 
    word.charAt(0).toUpperCase() + word.slice(1)
  ).join(' ');
}

function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => { t.classList.remove('show'); }, 3000);
}

// ‚îÄ‚îÄ Bulk Actions ‚îÄ‚îÄ
function toggleSelection(storyId) {
  const checkbox = document.getElementById(`check-${storyId}`);
  if (checkbox.checked) {
    selectedStories.add(storyId);
  } else {
    selectedStories.delete(storyId);
  }
  updateSelectionUI();
}

function updateSelectionUI() {
  const count = selectedStories.size;
  document.getElementById('selected-count').textContent = `${count} selected`;
  document.getElementById('bulk-actions').style.display = count > 0 ? 'flex' : 'none';
}

function selectAll() {
  selectedStories.clear();
  filteredStories.forEach(story => {
    const storyId = story.id || story.storyId;
    selectedStories.add(storyId);
    const checkbox = document.getElementById(`check-${storyId}`);
    if (checkbox) checkbox.checked = true;
  });
  updateSelectionUI();
}

function selectNone() {
  selectedStories.clear();
  document.querySelectorAll('.story-checkbox input').forEach(cb => cb.checked = false);
  updateSelectionUI();
}

async function bulkModerate(action) {
  if (selectedStories.size === 0) {
    showToast('No stories selected', 'error');
    return;
  }

  const confirmMsg = `${action === 'approve' ? 'Approve' : 'Reject'} ${selectedStories.size} stories?`;
  if (!confirm(confirmMsg)) return;

  // Disable bulk action buttons
  document.querySelectorAll('.bulk-actions button').forEach(btn => btn.disabled = true);
  
  const storyIds = Array.from(selectedStories);
  let completed = 0;
  let failed = 0;
  
  // Update progress
  const updateProgress = () => {
    document.getElementById('selected-count').textContent = 
      `Processing... ${completed + failed}/${storyIds.length}`;
  };
  
  try {
    const promises = storyIds.map(async storyId => {
      try {
        await moderate(storyId, action, true);
        completed++;
      } catch (err) {
        failed++;
        console.error(`Failed to moderate ${storyId}:`, err);
      }
      updateProgress();
    });
    
    await Promise.all(promises);
    
    if (failed === 0) {
      showToast(`Successfully ${action}d ${completed} stories!`, 'success');
    } else if (completed > 0) {
      showToast(`${completed} stories ${action}d, ${failed} failed`, 'error');
    } else {
      showToast(`All ${failed} operations failed`, 'error');
    }
    
    selectNone();
    setTimeout(() => loadStories(), 1000);
    
  } finally {
    // Re-enable bulk action buttons
    document.querySelectorAll('.bulk-actions button').forEach(btn => btn.disabled = false);
  }
}
</script>
</body>
</html>